---
- name: certbot installed
  ansible.builtin.apt:
    name: 
      - python3-certbot
      - python3-certbot-nginx
    state: latest
- name: certificate presence checked
  ansible.builtin.stat:
    path: /etc/letsencrypt/live/{{u22_nginx_reverse_proxy_fqdns | first | replace('*.', '')}}/cert.pem
  register: letsencrypt_cert
- name: nginx stopped, if existing cert not present
  ansible.builtin.service:
    name: nginx
    state: stopped
  when: not letsencrypt_cert.stat.exists
- name: new certificate created, if existing cert not present
  ansible.builtin.command: >-
    certbot --non-interactive --agree-tos --nginx
    --domains {{u22_nginx_reverse_proxy_fqdns | join(',')}}
    --email {{u22_nginx_reverse_proxy_admin_email}}
    {{"--test-cert" if u22_certbot_test else ""}}
  when: not letsencrypt_cert.stat.exists
- name: nginx started, if existing cert not present
  ansible.builtin.service:
    name: nginx
    state: started
  when: not letsencrypt_cert.stat.exists
- name: nginx reverse proxy config in place
  notify: restart nginx
  ansible.builtin.template:
    src: reverse_proxy
    dest: /etc/nginx/sites-available
    owner: root
    group: root
    mode: "0644"
- name: nginx reverse proxy enabled
  notify: restart nginx
  ansible.builtin.file:
    src: /etc/nginx/sites-available/reverse_proxy
    dest: /etc/nginx/sites-enabled/reverse_proxy
    state: link
